<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="~{/layout/layout::setContent(~{::content})}">
    <th:block th:fragment="content">
        <div class="pcoded-content">
            <div class="page-header">
                <div class="page-block">
                    <div class="row align-items-center">
                        <div class="col-md-12">
                            <div class="page-header-title">
                                <h5 class="m-b-10">거래명세서 발행</h5>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-12">
                <div class="card">
                    <div class="card-header">
                        <h5>발주서 목록</h5>
                    </div>
                    <div class="card-body">
                        <div>
                            <span class="badge badge-primary">입고예정일 선택</span>
                        </div>
                        <div class="row">
                            <div class="col">
                                <input type="date" id="sDate" class="form-control-sm" th:value="${defaultStartDate}"> ~
                                <input type="date" id="eDate" class="form-control-sm" th:value="${defaultEndDate}">
                                <button class="btn  btn-primary btn-sm" id="dateSearchBtn">조회</button>
                            </div>
                            <div class="col-md-auto">
                                <div class="input-group mb-3">
                                    <div class="input-group-prepend">
                                        <form>
                                            <select id="type" name="category" class="btn btn-primary dropdown-toggle dropdown-toggle-split btn-sm">
                                                <option value="OC">발주번호</option>
                                                <option value="IN">품목명</option>
                                                <option value="CN">업체명</option>
                                            </select>
                                            <input type="text" class="form-control-sm" id="searchText" aria-label="Text input with dropdown button">
                                            <button class="btn btn-primary btn-sm" id="searchBtn"><i class="feather icon-search"></i></button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover table-sm">
                                <thead>
                                <tr>
                                    <th class="align-middle" >발주번호</th>
                                    <th class="align-middle" >업체명</th>
                                    <th class="align-middle" >품목명</th>
                                    <th class="align-middle" >발주일</th>
                                    <th class="align-middle" >입고예정일</th>
                                    <th class="align-middle" style="width:30px;">명세서</th>
                                    <th class="align-middle" style="width:15px;">발행횟수</th>
                                </tr>
                                </thead>
                                <tbody id = "poTbody">
                                </tbody>
                            </table>
                            <nav aria-label="Page navigation">
                                <ul class="pagination justify-content-end" id="searchPageList">
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
       
        <script>
             var amount = 10;
             var header = $('meta[name="_csrf_header"]').attr("content");
            var _csrfToken = $('#_csrf_token').val();
            var crntPage;
            $(function(){
                var criteria = {"startDate":$('#sDate').val(),"endDate":$('#eDate').val(),"type":"IN","keyword":"","pageNum":0,"amount":amount};
                loadList(criteria);
            })

            $('#dateSearchBtn').on("click",function(){
                loadList({"startDate":$('#sDate').val(),"endDate":$('#eDate').val(),"type":$('#type').val(),"keyword":$('#searchText').val(),"pageNum":0,"amount":amount})
            })

            $('#searchBtn').on("click", function(e){
                e.preventDefault();
                loadList({"startDate":$('#sDate').val(),"endDate":$('#eDate').val(),"type":$('#type').val(),"keyword":$('#searchText').val(),"pageNum":0,"amount":amount})
            })

            $('.pagination').on("click","a", function(){
                id = $(this).data("paging");
                if(id == 'next'){
                    id = parseInt(crntPage/10)+1;
                    id = id*10+1;
                }else if(id == 'prev'){
                    id = parseInt(crntPage/10);
                    id = id*10;
                }
                loadList({"startDate":$('#sDate').val(),"endDate":$('#eDate').val(),"type":$('#type').val(),"keyword":$('#searchText').val(),"pageNum":id-1,"amount":amount});
            })

            $('#poTbody').on("click","button",function(){
                console.log("여기다 애송이",$(this));
                if(!($(this).hasClass('disabled'))){
                    let popOption = "width = 1200px, height = 730px, top = 100px, left = 100px, scrollbars=yes";
                    let popUrl = '/inv/statement-preview/'+$(this).parent().siblings('.poNum').text();
                    console.log($(this).parent('.poNum').text());
                    window.open(popUrl,'pop',popOption);
                }
            })

            function loadList(criteria){
                $.ajax({
                    type:"get",
                    url:"/invapi/statement-get-data",
                    data:criteria,
                    success:function(res){
                        console.log("성공, 데이터확인",res);
                        $('#poTbody').empty();
                        result = res.dataList;
                        var rsStr = "";
                        for(let i = 0; i < result.length; i++){
                            rsStr += "<tr id ='"+i+"result' class='result'><td class='poNum'>"+result[i].purch_order_number+"</td><td>"+result[i].company_name+"</td><td>"+result[i].item_name_string+"</td><td>"+dateFormatter(result[i].purch_order_date)+"</td><td>"+dateFormatter(result[i].receive_duedate)+"</td><td><button class='btn  btn-secondary btn-sm print' id='"+i+"print'>발행</button></td><td>"+result[i].statement_publish_count+"</td></tr>";
                        }
                        $('#poTbody').html(rsStr);
                        $('th').addClass('text-center');
                        $('td').addClass('text-center');
                        console.log("전체페이지 수",res.page_count);
                        var pageList = res.pageList;
                        var pageStr ="";
                        for(let j = 0; j < pageList.length; j++){
                            pageStr +="<li class='page-item'>";
                            if(pageList[j] == "prev"){
                                pageStr += "<a class='page-link' data-paging='prev' aria-label='Previous'><span aria-hidden='true'>&laquo;</span><span class='sr-only'>Previous</span></a>";
                            }else if(pageList[j]=="next"){
                                pageStr += "<a class='page-link'  data-paging='next' aria-label='Next'><span aria-hidden='true'>&raquo;</span><span class='sr-only'>Next</span></a>";
                            }else{
                                pageStr += "<a class='page-link'  data-paging='"+pageList[j]+"'>"+pageList[j]+"</a>";
                            }
                            pageStr +="</li>"
                        }
                        $('#searchPageList').html(pageStr);
                        $('[data-paging ='+res.currentPage+']').parent().addClass("active");
                        crntPage = criteria.pageNum + 1;
                    
                        makeCenter();
                    },
                    error:function(a,b,c){
                        console.log("에러");
                        console.log("a",a);
                        console.log("b",b);
                        console.log("c",c);
                    }
                })
            }

            function dateFormatter(date){
                if(date != null){
                    var d = new Date(date);
                    let month = d.getMonth()+1;
                    let year = d.getFullYear();
                    let day = d.getDate();
                    return [year,month,day].join('-');
                }else{
                    return "-";
                }
            }

            function makeCenter(){
                $('th').addClass('text-center');
                $('td').addClass('text-center');
            }
        </script>
    </th:block>
</th:block>
</html>